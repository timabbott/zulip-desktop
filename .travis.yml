sudo: required
dist: trusty

os:
  - osx
  - linux

osx_image: xcode9.0

addons:
  apt:
    packages:
      - build-essential
      - libxext-dev
      - libxtst-dev
      - libxkbfile-dev
      - g++-multilib
      - libxss-dev:i386
  artifacts:
    paths:
      - $(ls ./dist/*.AppImage | tr "\n" ":")
      - $(ls ./dist/*.deb | tr "\n" ":")
      - $(ls ./dist/*.snap | tr "\n" ":")
      - $(ls ./dist/*.dmg | tr "\n" ":")
      - $(ls ./dist/*.zip | tr "\n" ":")
      - $(ls ./dist/*.dmg.blockmap | tr "\n" ":")
      - $(ls ./dist/github/*.json | tr "\n" ":")
      - $(ls ./dist/github/*.yml | tr "\n" ":")
      - $(ls ./dist/*.yml | tr "\n" ":")
      - $(ls ./dist/mac/*.yml | tr "\n" ":")
      - $(ls ./dist/linux/*.yml | tr "\n" ":")

language: node_js
node_js:
- '6'

before_install:
  - ./scripts/travis-xvfb.sh
  - npm install -g gulp
  - npm install

cache:
  directories:
    - node_modules
    - app/node_modules
    - ~/.cache

script:
  - npm run travis
  - chmod +x ./scripts/install-release-dependencies.sh
  - ./scripts/install-release-dependencies.sh
  - electron-builder --x64 --ia32
  - node ./scripts/prepare-artifacts.js
  # log out /dist files might be useful to know
  # what files are uploaded
  - ls dist

notifications:
  webhooks:
    urls:
      - https://zulip.org/zulipbot/travis
    on_success: always
    on_failure: always
